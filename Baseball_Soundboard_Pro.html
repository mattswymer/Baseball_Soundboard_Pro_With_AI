<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Baseball Soundboard Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Base styles for a dark theme */
  body {
    background-color: #1a202c; /* gray-900 */
    color: #f7fafc; /* gray-100 */
    font-family: 'Inter', sans-serif;
    padding: 1.5rem;
  }

  /* Custom styles for the toggle switch for a cleaner look */
  .toggle {
    position: relative;
    width: 42px;
    height: 24px;
  }
  .toggle input {
    display: none;
  }
  .toggle .track {
    position: absolute;
    inset: 0;
    border-radius: 9999px;
    background: #475569; /* slate-700 */
    transition: 0.2s;
  }
  .toggle .thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: #fff;
    border-radius: 9999px;
    transition: 0.2s;
  }
  .toggle input:checked + .track {
    background: #22c55e; /* green-500 */
  }
  .toggle input:checked + .track .thumb {
    transform: translateX(18px);
  }

  /* Styling for play/pause/stop buttons */
  .btn-playpause {
    background-color: #22c55e; /* green-500 */
    color: white;
    border-radius: 9999px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  .btn-stop {
    background-color: #dc2626; /* red-600 */
    color: white;
    border-radius: 9999px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  .dragging { opacity: .5; }

  /* Progress bar styling */
  .progress-bar-wrap {
    height: 8px;
    background-color: #334155; /* slate-800 */
    border-radius: 9999px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    width: 0%;
    background-color: #3b82f6; /* blue-500 */
  }
  .progress-bar-wrap:hover .progress-bar {
    cursor: pointer;
  }

  /* Drop zone styling */
  .drop-zone {
    transition: all 0.2s ease;
  }
  .drop-zone.drag-over {
    border-color: #0ea5e9 !important;
    background-color: rgba(14, 165, 233, 0.1) !important;
  }
</style>
</head>
<body class="bg-gray-900 text-white p-6">
  <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
    <h1 class="text-3xl font-bold flex items-center gap-3">
      <span>‚öæ</span> Baseball Soundboard Pro
    </h1>
    <div class="flex flex-wrap items-center gap-6">
      <div class="flex items-center gap-3">
        <label for="fadeInSlider" class="text-sm shrink-0">Fade In (s)</label>
        <input id="fadeInSlider" type="range" min="0" max="8" step="0.1" value="2.0" class="w-24 md:w-40" />
        <span id="fadeInVal" class="w-8 text-right">2.0</span>
      </div>
      <div class="flex items-center gap-3">
        <label for="fadeOutSlider" class="text-sm shrink-0">Fade Out (s)</label>
        <input id="fadeOutSlider" type="range" min="0" max="8" step="0.1" value="2.0" class="w-24 md:w-40" />
        <span id="fadeOutVal" class="w-8 text-right">2.0</span>
      </div>
      <button id="fadeAll" class="bg-red-600 hover:bg-red-500 active:bg-red-700 px-4 py-2 rounded-xl font-semibold shadow">Fade Out All</button>
    </div>
  </header>

  <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <section>
      <div class="flex items-center gap-2 text-lg font-semibold mb-2">
        <span>üì¢ Announcements</span>
        <span id="annCount" class="text-xs bg-slate-700 px-2 py-0.5 rounded">0</span>
      </div>
      <div id="annCol"
           class="drop-zone group relative p-4 min-h-[260px] border-2 border-dashed border-slate-700 rounded-2xl bg-slate-800/30">
        <div class="drop-area pointer-events-none absolute inset-0 flex flex-col items-center justify-center text-slate-400 group-[.has-items]:hidden">
          <div class="text-3xl">Ôºã</div>
          <div>Drop sounds here or click to import</div>
        </div>
      </div>
      <input id="annInput" type="file" accept="audio/*" multiple class="hidden" />
    </section>

    <section>
      <div class="flex items-center gap-2 text-lg font-semibold mb-2">
        <span>üéµ Music</span>
        <span id="musicCount" class="text-xs bg-slate-700 px-2 py-0.5 rounded">0</span>
      </div>
      <div id="musicCol"
           class="drop-zone group relative p-4 min-h-[260px] border-2 border-dashed border-slate-700 rounded-2xl bg-slate-800/30">
        <div class="drop-area pointer-events-none absolute inset-0 flex flex-col items-center justify-center text-slate-400 group-[.has-items]:hidden">
          <div class="text-3xl">Ôºã</div>
          <div>Drop sounds here or click to import</div>
        </div>
      </div>
      <input id="musicInput" type="file" accept="audio/*" multiple class="hidden" />
    </section>
  </main>

<script>
// ===== Utilities =====
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
const formatTime = (sec) => {
  if (isNaN(sec) || !isFinite(sec)) return '0:00';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
};

let fadeInTime = 2.0;
let fadeOutTime = 2.0;
$('#fadeInSlider').addEventListener('input', e => { fadeInTime = parseFloat(e.target.value); $('#fadeInVal').textContent = fadeInTime.toFixed(1); });
$('#fadeOutSlider').addEventListener('input', e => { fadeOutTime = parseFloat(e.target.value); $('#fadeOutVal').textContent = fadeOutTime.toFixed(1); });
$('#fadeInVal').textContent = fadeInTime.toFixed(1);
$('#fadeOutVal').textContent = fadeOutTime.toFixed(1);

const columns = [{ wrap: $('#annCol'), input: $('#annInput') }, { wrap: $('#musicCol'), input: $('#musicInput') }];
const activeAudios = new Set(); // Keep track of all playing audios

function setHasItemsClass(col) {
  if (col.children.length > 1) col.classList.add('has-items'); // > 1 because drop-area div is always there
  else col.classList.remove('has-items');
}

function updateCounts() {
  $('#annCount').textContent = $('#annCol').querySelectorAll('.sound-card').length;
  $('#musicCount').textContent = $('#musicCol').querySelectorAll('.sound-card').length;
  columns.forEach(c => setHasItemsClass(c.wrap));
}

// ===== Fade helper using rAF =====
function fadeTo(audio, target, durationMs, { stopAfter = false, reset = false, onDone } = {}) {
  const start = audio.volume;
  const startTime = performance.now();
  const dur = Math.max(0, durationMs);
  if (audio.__fadeRaf) cancelAnimationFrame(audio.__fadeRaf);

  function step(t) {
    const p = dur === 0 ? 1 : Math.min(1, (t - startTime) / dur);
    const v = start + (target - start) * p;
    audio.volume = Math.min(1, Math.max(0, v));
    if (p < 1) {
      audio.__fadeRaf = requestAnimationFrame(step);
    } else {
      if (stopAfter) {
        audio.pause();
        if (reset) audio.currentTime = 0;
      }
      if (onDone) onDone();
    }
  }
  audio.__fadeRaf = requestAnimationFrame(step);
}

// ===== Card builder =====
function makeToggle(labelText, id) {
  const wrap = document.createElement('label');
  wrap.className = 'flex items-center gap-2 text-xs select-none';
  wrap.setAttribute('for', id);
  wrap.innerHTML = `
    <span>${labelText}</span>
    <span class="toggle inline-block">
      <input type="checkbox" id="${id}" />
      <span class="track"><span class="thumb"></span></span>
    </span>`;
  return { wrap, input: wrap.querySelector('input') };
}

function createCard({ name, url }) {
  const card = document.createElement('div');
  card.className = 'sound-card group/card bg-slate-800 border border-slate-700 rounded-2xl p-3 mb-3 shadow flex flex-col gap-2 cursor-grab';
  card.draggable = true;

  const row = document.createElement('div');
  row.className = 'flex items-center gap-3';
  card.appendChild(row);

  // Controls
  const dragDot = document.createElement('div');
  dragDot.className = 'text-slate-500 cursor-grab select-none';
  dragDot.textContent = '‚ãÆ‚ãÆ';

  const playBtn = document.createElement('button');
  playBtn.className = 'btn-playpause shrink-0';
  playBtn.setAttribute('aria-label', 'Play');
  playBtn.innerHTML = '‚ñ∂';

  const stopBtn = document.createElement('button');
  stopBtn.className = 'btn-stop shrink-0';
  stopBtn.setAttribute('aria-label', 'Stop');
  stopBtn.innerHTML = '‚èπ';

  const title = document.createElement('div');
  title.className = 'font-semibold flex-1 truncate';
  title.textContent = name;

  const editBtn = document.createElement('button');
  editBtn.className = 'text-slate-300 hover:text-white';
  editBtn.setAttribute('title', 'Rename');
  editBtn.innerHTML = '‚úé';

  const delBtn = document.createElement('button');
  delBtn.className = 'text-slate-300 hover:text-red-400';
  delBtn.setAttribute('title', 'Delete');
  delBtn.innerHTML = 'üóë';

  row.append(dragDot, playBtn, stopBtn, title, editBtn, delBtn);

  // Toggles
  const toggles = document.createElement('div');
  toggles.className = 'flex items-center gap-4 pl-14';
  const fadeInT = makeToggle('Fade In', `fadeInToggle-${Date.now()}-${Math.random()}`);
  const fadeOutT = makeToggle('Fade Out', `fadeOutToggle-${Date.now()}-${Math.random()}`);
  fadeInT.input.checked = true;
  fadeOutT.input.checked = true;
  toggles.append(fadeInT.wrap, fadeOutT.wrap);
  card.appendChild(toggles);

  // Progress
  const progressWrap = document.createElement('div');
  progressWrap.className = 'pl-14';
  progressWrap.innerHTML = `
    <div class="progress-bar-wrap"><div class="progress-bar"></div></div>
    <div class="flex justify-between text-xs text-slate-300 mt-0.5">
      <span class="cur">0:00</span>
      <span class="dur">0:00</span>
    </div>`;
  const progressBg = progressWrap.querySelector('.progress-bar-wrap');
  const progress = progressWrap.querySelector('.progress-bar');
  const curLbl = progressWrap.querySelector('.cur');
  const durLbl = progressWrap.querySelector('.dur');
  card.appendChild(progressWrap);

  // Audio element
  const audio = new Audio();
  audio.src = url;
  audio.preload = 'metadata';
  audio.crossOrigin = 'anonymous';
  audio.volume = 1;
  card.audioElement = audio; // Custom property to link audio to card

  let isPlaying = false;

  // Visual active state
  function setActive(on) {
    if (on) {
      card.classList.add('ring-2', 'ring-blue-400', 'bg-slate-700');
      playBtn.innerHTML = '‚è∏';
      playBtn.setAttribute('aria-label', 'Pause');
    } else {
      card.classList.remove('ring-2', 'ring-blue-400', 'bg-slate-700');
      playBtn.innerHTML = '‚ñ∂';
      playBtn.setAttribute('aria-label', 'Play');
    }
  }

  // Duration once known
  audio.addEventListener('loadedmetadata', () => {
    durLbl.textContent = formatTime(audio.duration);
  });

  // Progress updates
  audio.addEventListener('timeupdate', () => {
    if (!isNaN(audio.duration) && audio.duration > 0) {
      const percentage = (audio.currentTime / audio.duration) * 100;
      progress.style.width = `${percentage}%`;
      curLbl.textContent = formatTime(audio.currentTime);
    }
  });

  // Scrub
  progressBg.addEventListener('click', (e) => {
    if (!isNaN(audio.duration) && audio.duration > 0) {
      const rect = progressBg.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percentage = clickX / rect.width;
      audio.currentTime = percentage * audio.duration;
    }
  });

  // Ended
  audio.addEventListener('ended', () => {
    isPlaying = false;
    setActive(false);
    progress.style.width = '0%';
    curLbl.textContent = '0:00';
    activeAudios.delete(audio);
  });

  // Play/Pause logic with fades
  playBtn.addEventListener('click', () => {
    if (!isPlaying) {
      // play
      if (fadeInT.input.checked) {
        audio.volume = 0;
      }
      audio.play();
      isPlaying = true;
      setActive(true);
      activeAudios.add(audio);
      if (fadeInT.input.checked) {
        fadeTo(audio, 1, Math.round(fadeInTime * 1000));
      } else {
        audio.volume = 1;
      }
    } else {
      // pause
      if (fadeOutT.input.checked) {
        fadeTo(audio, 0, Math.round(fadeOutTime * 1000), {
          stopAfter: true,
          reset: false,
          onDone: () => {
            isPlaying = false;
            setActive(false);
            activeAudios.delete(audio);
          }
        });
      } else {
        audio.pause();
        isPlaying = false;
        setActive(false);
        activeAudios.delete(audio);
      }
    }
  });

  // Stop button
  stopBtn.addEventListener('click', () => {
    if (fadeOutT.input.checked && !audio.paused && audio.volume > 0) {
      fadeTo(audio, 0, Math.round(fadeOutTime * 1000), {
        stopAfter: true,
        reset: true,
        onDone: () => {
          isPlaying = false;
          setActive(false);
          activeAudios.delete(audio);
        }
      });
    } else {
      audio.pause();
      audio.currentTime = 0;
      isPlaying = false;
      setActive(false);
      activeAudios.delete(audio);
    }
  });

  // Rename
  editBtn.addEventListener('click', () => {
    const newName = prompt('Rename sound', title.textContent.trim());
    if (newName && newName.trim()) title.textContent = newName.trim();
  });

  // Delete
  delBtn.addEventListener('click', () => {
    try {
      audio.pause();
      activeAudios.delete(audio);
    } catch (e) {}
    card.remove();
    updateCounts();
  });

  // Drag handle
  card.addEventListener('dragstart', (e) => {
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  card.addEventListener('dragend', () => card.classList.remove('dragging'));

  return card;
}

// ===== Column behaviors =====
columns.forEach(({ wrap, input }) => {
  // Click-to-import (only when clicking blank space, not on a card)
  wrap.addEventListener('click', (e) => {
    // Only trigger if clicking on the wrapper itself or the drop-area div
    if (e.target === wrap || e.target.closest('.drop-area')) {
      input.click();
    }
  });

  // Drag/drop import with visual feedback
  wrap.addEventListener('dragenter', (e) => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if (!dragging) { // Only show drop zone feedback for external files
      wrap.classList.add('drag-over');
    }
  });

  wrap.addEventListener('dragover', (e) => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if (dragging) {
      // This is an internal card being dragged
      wrap.classList.remove('drag-over');
      wrap.classList.add('ring-2', 'ring-sky-500');
    } else {
      // This is likely a file from outside
      wrap.classList.add('drag-over');
    }
  });

  wrap.addEventListener('dragleave', (e) => {
    // Only remove classes if we're actually leaving the wrapper
    if (!wrap.contains(e.relatedTarget)) {
      wrap.classList.remove('ring-2', 'ring-sky-500', 'drag-over');
    }
  });

  wrap.addEventListener('drop', (e) => {
    e.preventDefault();
    wrap.classList.remove('ring-2', 'ring-sky-500', 'drag-over');

    const files = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith('audio/'));
    if (files.length) {
      addFilesToColumn(files, wrap);
    } else {
      const dragging = document.querySelector('.dragging');
      if (dragging && dragging.parentElement !== wrap) {
        wrap.appendChild(dragging);
        updateCounts();
      }
    }
  });

  // Reordering within column
  wrap.addEventListener('dragover', (e) => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if (!dragging) return;
    const afterElement = getDragAfterElement(wrap, e.clientY);
    if (afterElement == null) {
      wrap.appendChild(dragging);
    } else {
      wrap.insertBefore(dragging, afterElement);
    }
  });

  // File input for this column
  input.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length) {
      addFilesToColumn(files, wrap);
      input.value = '';
    }
  });
});

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.sound-card:not(.dragging)')];

  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;

    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function addFilesToColumn(files, columnEl) {
  files.forEach(file => {
    const url = URL.createObjectURL(file);
    const card = createCard({ name: file.name.replace(/\.[^/.]+$/, ''), url });
    columnEl.appendChild(card);
  });
  updateCounts();
}

// Move dragged cards between columns too
['annCol', 'musicCol'].forEach(id => {
  const col = document.getElementById(id);
  col.addEventListener('drop', () => updateCounts());
});

// Fade Out All - Fixed implementation
$('#fadeAll').addEventListener('click', () => {
  // Get all sound cards that are currently playing
  const allCards = document.querySelectorAll('.sound-card');

  allCards.forEach(card => {
    const audio = card.audioElement;
    if (audio && !audio.paused) {
      // Find the stop button and click it
      const stopBtn = card.querySelector('.btn-stop');
      if (stopBtn) {
        stopBtn.click();
      }
    }
  });
});

updateCounts();

// Remove the initial placeholder card since we want to show the drop zones
// const initialAnnouncement = createCard({ name: 'Next to the Plate...', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' });
// $('#annCol').appendChild(initialAnnouncement);
// updateCounts();
</script>
</body>
</html>
